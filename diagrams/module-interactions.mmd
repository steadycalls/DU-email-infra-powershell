graph LR
    subgraph "Configuration Layer"
        Config["Config Module<br/><br/>ðŸ“‹ Responsibilities:<br/>â€¢ Load env variables<br/>â€¢ Parse JSON config<br/>â€¢ Validate credentials<br/>â€¢ Define retry params<br/>â€¢ Define aliases<br/><br/>ðŸ”‘ Key Methods:<br/>â€¢ New-EmailInfraConfig()<br/>â€¢ LoadFromEnvironment()<br/>â€¢ LoadFromFile()<br/>â€¢ Validate()"]
    end
    
    subgraph "State Management Layer"
        State["State Manager<br/><br/>ðŸ“‹ Responsibilities:<br/>â€¢ Track domain states<br/>â€¢ Persist to JSON<br/>â€¢ Thread-safe access<br/>â€¢ Error tracking<br/>â€¢ Summary reporting<br/><br/>ðŸ”‘ Key Methods:<br/>â€¢ AddDomain()<br/>â€¢ UpdateDomain()<br/>â€¢ GetDomain()<br/>â€¢ GetSummary()<br/>â€¢ ExportFailures()"]
    end
    
    subgraph "Logging Layer"
        Logger["Logger Module<br/><br/>ðŸ“‹ Responsibilities:<br/>â€¢ Console output<br/>â€¢ File logging<br/>â€¢ Structured JSON<br/>â€¢ Thread-safe writes<br/>â€¢ Log level filtering<br/><br/>ðŸ”‘ Key Methods:<br/>â€¢ Debug()<br/>â€¢ Info()<br/>â€¢ Warning()<br/>â€¢ Error()<br/>â€¢ Critical()"]
    end
    
    subgraph "API Client Layer"
        FE["Forward Email Client<br/><br/>ðŸ“‹ Responsibilities:<br/>â€¢ Domain CRUD<br/>â€¢ Verification<br/>â€¢ Alias management<br/>â€¢ Retry logic<br/>â€¢ Rate limit handling<br/><br/>ðŸ”‘ Key Methods:<br/>â€¢ CreateDomain()<br/>â€¢ GetDomain()<br/>â€¢ VerifyDomain()<br/>â€¢ CreateAlias()<br/>â€¢ ListAliases()"]
        
        CF["Cloudflare Client<br/><br/>ðŸ“‹ Responsibilities:<br/>â€¢ Zone lookup<br/>â€¢ DNS record CRUD<br/>â€¢ Idempotent ops<br/>â€¢ Retry logic<br/>â€¢ Rate limit handling<br/><br/>ðŸ”‘ Key Methods:<br/>â€¢ GetZoneId()<br/>â€¢ CreateDnsRecord()<br/>â€¢ ListDnsRecords()<br/>â€¢ GetOrCreateDnsRecord()"]
    end
    
    subgraph "Orchestration Layer"
        Main["Main Script<br/><br/>ðŸ“‹ Responsibilities:<br/>â€¢ Load domains<br/>â€¢ Coordinate modules<br/>â€¢ Process pipeline<br/>â€¢ Concurrency control<br/>â€¢ Error handling<br/><br/>ðŸ”‘ Functions:<br/>â€¢ Process-Domain()<br/>â€¢ Concurrency loop<br/>â€¢ Summary reporting"]
    end
    
    %% Configuration dependencies
    Config -->|Provides settings| Main
    Config -->|Retry config| FE
    Config -->|Retry config| CF
    Config -->|Log level| Logger
    Config -->|Alias definitions| Main
    
    %% State management dependencies
    State -->|Domain records| Main
    Main -->|Update states| State
    FE -->|Log operations| Logger
    CF -->|Log operations| Logger
    State -->|Log operations| Logger
    
    %% API client usage
    Main -->|Domain operations| FE
    Main -->|DNS operations| CF
    
    %% Logging usage
    Main -->|Log progress| Logger
    
    %% Data flow annotations
    Config -.->|"1. Initialize"| Main
    Main -.->|"2. Load state"| State
    Main -.->|"3. Process domains"| FE
    Main -.->|"4. Configure DNS"| CF
    Main -.->|"5. Update state"| State
    Main -.->|"6. Log events"| Logger
    
    %% Styling
    classDef configStyle fill:#fff3e0,stroke:#e65100,stroke-width:3px
    classDef stateStyle fill:#e1f5ff,stroke:#01579b,stroke-width:3px
    classDef logStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:3px
    classDef apiStyle fill:#e8f5e9,stroke:#1b5e20,stroke-width:3px
    classDef mainStyle fill:#fce4ec,stroke:#880e4f,stroke-width:4px
    
    class Config configStyle
    class State stateStyle
    class Logger logStyle
    class FE,CF apiStyle
    class Main mainStyle
